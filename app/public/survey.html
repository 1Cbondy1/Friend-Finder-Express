<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <title>Friend-Finder-Express</title>

    <!-- Latest compiled and minified CSS & JS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <!-- Font Awesome Glyphicons -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

    <!-- Chosen -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.5.1/chosen.jquery.min.js"></script>

</head>

<body>

    <div class="container">

        <h2>Frinder Questionnaire</h2>
        <hr>

        <h3><strong>About You</strong></h3>
        <h4>Name (Required)</h4>
        <input type="text" id="name" class="form-control" required>

        <h4>Link to Photo Image (Required)</h4>
        <input type="text" id="photo" class="form-control" required>

        <hr>

        <h3><strong>Question 1</strong></h3>
        <h4>You are almost never late for your appointments.</h4>
        <select class="chosen-select" id="q1">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 2</strong></h3>
        <h4>You believe in the importance of art.</h4>
        <select class="chosen-select" id="q2">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 3</strong></h3>
        <h4>You like to be engaged in an active and fast-paced job.</h4>
        <select class="chosen-select" id="q3">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 4</strong></h3>
        <h4>You rarely do something just out of sheer curiosity.</h4>
        <select class="chosen-select" id="q4">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 5</strong></h3>
        <h4>You are always busy.</h4>
        <select class="chosen-select" id="q5">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 6</strong></h3>
        <h4>It is often difficult for you to relate to other peopleâ€™s feelings.</h4>
        <select class="chosen-select" id="q6">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 7</strong></h3>
        <h4>You see yourself as sympathetic and warm.</h4>
        <select class="chosen-select" id="q7">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 8</strong></h3>
        <h4>You rarely get carried away by fantasies and ideas.</h4>
        <select class="chosen-select" id="q8">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 9</strong></h3>
        <h4>You prefer to act immediately rather than speculate about various options.</h4>
        <select class="chosen-select" id="q9">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <h3><strong>Question 10</strong></h3>
        <h4>You feel more energetic after spending time with a group of people.</h4>
        <select class="chosen-select" id="q10">
            <option value=""></option>
            <option value="1">1 (Strongly Disagree)</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5 (Strongly Agree)</option>
        </select>

        <br>
        <br>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary btn-lg btn-block" style="background-color:#FF3F57; width:150px" id="submit"><i class="fa fa-check-circle" aria-hidden="true"></i>Submit</button>

        <hr>
        <footer class="footer">
            <div class="container">
                <p><a href="/api/friends">API Friends List</a> | <a href="https://github.com/1Cbondy1/Friend-Finder-Express">GitHub Repo</a></p>
            </div>
        </footer>

    </div>

    <!-- Modal -->
    <div id="results-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content" style="text-align:center">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title"><strong>Best Match</strong></h2>
                </div>
                <div class="modal-body">
                    <h2 id="match-name"></h2>
                    <img id="match-img" style="width:400px" src="#" alt="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>
    </div>

    <script type="text/javascript">
        // Chosen CSS
        var config = {
            ".chosen-select": {},
            ".chosen-select-deselect": {allow_single_deselect: true},
            ".chosen-select-no-single": {disable_search_threshold: 10},
            ".chosen-select-no-results": {no_results_text: "Oops, nothing found!"},
            ".chosen-select-width": {width: "95%"}
        };

        for (var selector in config) {
            $(selector).chosen(config[selector]);
        }

        // Capture the form inputs
        $("#submit").on("click", function(event) {
            event.preventDefault();

            // Form validation
            function validateForm() {
            var isValid = true;
            $(".form-control").each(function() {
                if ($(this).val() === "") {
                isValid = false;
                }
            });
            $(".chosen-select").each(function() {

                if ($(this).val() === "") {
                isValid = false;
                }
            });
            return isValid;
            }

            // If all required fields are filled
            if (validateForm()) {
            // Create an object for the user data
            var newFriend = {
                name: $("#name").val(),
                photo: $("#photo").val(),
                scores: [
                $("#q1").val(),
                $("#q2").val(),
                $("#q3").val(),
                $("#q4").val(),
                $("#q5").val(),
                $("#q6").val(),
                $("#q7").val(),
                $("#q8").val(),
                $("#q9").val(),
                $("#q10").val()
                ]
            };

            // AJAX post the data to the friends API.
            $.post("/api/friends", newFriend) 
                .then(function(data) {
                console.log("add.html", data);
                alert("Adding friend...");
            });

            // this long convoluted GET request is intended to find the closest friend match based on the sum of the differences between all survey answers. The api "friend" object with the lowest total numerical difference between its "score" and the user's input "score" is the closest match.
            $.get("/api/friends", function(data) {

                // array for holding each existing friend objects match number TM
                var matchArr = [];
                
                // loops through all of the existing friend objects
                for (var j = 0; j < data.length; j++) {
                    var finalResult = 0;
                    var resultArr = [];

                    // calculates difference between all user "scores" and existing friend "scores", pushes each to resultArr
                    for (var i = 0; i < 10; i++) {
                        var newScore = newFriend.scores[i];
                        var result = newScore - data[j].scores[i];
                        resultArr.push(result);
                    }
                    console.log(resultArr);

                    // calculates the sum of each question's resultsArr to generate the match number TM and pushes to matchArr array
                    for (var i = 0; i < 10; i++) {
                        finalResult += parseInt(resultArr[i]);
                    }
                    finalResAbs = (Math.abs(finalResult));
                    matchArr.push(finalResAbs);
                    console.log("Final Result: " + finalResAbs);
                }
                
                // bug that pushes 0 at the end of matchArr, solved it by cutting off the end of the array
                matchArr.splice(-1,1);
                console.log(matchArr);

                // function for finding the smallest number in an array
                function indexOfSmallest(a) {
                    return a.indexOf(Math.min.apply(Math, a));
                }
                var min = indexOfSmallest(matchArr);
                console.log(min);

                $("#match-name").text(data[min].name);
                $("#match-img").attr("src", data[min].photo);

                // Show the modal with the best match
                $("#results-modal").modal("toggle");
            
            });
            } else {
            alert("Please fill out all fields before submitting!");
            }
        });
    </script>

</body>

</html>
